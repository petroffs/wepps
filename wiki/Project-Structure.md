# Структура проекта Wepps

## Обзор

Wepps использует модульную архитектуру, где функциональность разделена на отдельные пакеты и компоненты.

## Основные директории и файлы

```
wepps/
├── index.php              # Точка входа приложения
├── install.php            # Скрипт установки
├── config.php             # Конфигурация проекта
├── config.cnf             # Конфигурация MySQL для CLI
├── configloader.php       # Загрузчик конфигурации
├── favicon.ico            # Иконка сайта
├── LICENSE                # Лицензия MIT
├── README.md              # Основная документация
├── .gitignore             # Правила игнорирования Git
├── packages/              # Основные модули платформы
│   ├── WeppsCore/        # Ядро системы
│   ├── WeppsAdmin/       # Административная панель
│   ├── WeppsExtensions/  # Расширения
│   ├── composer.json     # Composer-зависимости
│   └── vendor_local/     # Локальные Composer-пакеты
└── _wepps/               # Административный интерфейс
    ├── .htaccess         # Настройки доступа и переадресаций
    └── index.php         # Точка входа в админ-панель
```

## Описание компонентов

### Корневые файлы

#### index.php
**Назначение:** Главная точка входа в приложение.

Этот файл обрабатывает все входящие HTTP-запросы и инициализирует процесс загрузки приложения.

#### install.php
**Назначение:** Скрипт установки платформы.

**Функциональность:**
- Проверка наличия Composer-зависимостей
- Установка/обновление зависимостей
- Заполнение базы данных из дампа
- Создание учётной записи администратора

#### config.php
**Назначение:** Основной конфигурационный файл.

**Содержит:**
- Параметры подключения к БД
- Пути к директориям
- Настройки окружения
- Параметры кэширования

Подробнее см. [Конфигурация](Configuration.md).

#### config.cnf
**Назначение:** Конфигурация MySQL для CLI-операций.

Используется скриптами резервного копирования и обновления для доступа к базе данных.

#### configloader.php
**Назначение:** Загрузчик конфигурации.

Отвечает за загрузку и инициализацию настроек приложения из `config.php`.

### Директория packages/

#### WeppsCore/
**Назначение:** Ядро системы.

**Содержит:**
- Базовые классы и интерфейсы
- Система маршрутизации
- Работа с базой данных
- Обработка запросов и ответов
- Система шаблонизации (Smarty)
- Утилиты и хелперы

**Основные компоненты:**
- `Cli` — Методы для работы с командной строкой, вывод сообщений и управление файлами
- `Connect` — Работа с базой данных через PDO и кэширование запросов через Memcached
- `Data` — ORM-подобный интерфейс для работы с БД: CRUD операции, пагинация, управление схемами таблиц
- `Exception` — Обработка и отображение ошибок, страницы 404 и кастомных ошибок
- `Extension` — Абстрактный базовый класс для расширений с навигацией, шаблонами и обработкой данных
- `Language` — Работа с языками и переводами, получение информации о текущем языке раздела
- `Memcached` — Функциональность для работы с Memcached/Memcache сервером
- `Navigator` — Навигация по сайту, обработка URL и управление контентом
- `NavigatorData` — Расширение Data для работы с навигацией по сайту
- `Permissions` — Управление правами доступа пользователей
- `Request` — Абстрактный класс для обработки HTTP-запросов
- `Smarty` — Работа с шаблонизатором Smarty
- `Tasks` — Трекинг выполнения локальных сервисов, регистрация CLI/HTTP запросов
- `TemplateHeaders` — Генерация HTML-кода ссылок на CSS/JS и meta-тегов для шаблонов
- `TextTransforms` — Преобразование текста и числовых значений в различные форматы
- `Users` — Работа с пользователями и JWT-токенами
- `Utils` — Набор вспомогательных функций для обработки данных, форматирования и отладки
- `Validator` — Валидация различных типов данных (email, URL, даты, целые числа и т.д.)

#### WeppsAdmin/
**Назначение:** Административная панель.

**Содержит:**
- Интерфейс администрирования
- Система обновлений
- Управление пользователями
- Управление контентом
- Резервное копирование
- Системные расширения

**Основные компоненты:**
- `Admin` — Основной класс админ-панели: авторизация, навигация и управление интерфейсом
- `Home` — Главная страница админ-панели и форма авторизации
- `NavigatorAd` — Управление структурой навигации сайта в админ-панели
- `Lists` — Управление списками: отображение таблиц, редактирование элементов, пагинация
- `ConfigExtensions` — Управление расширениями в админ-панели, отображение списка и настроек
- `Backup` — Создание резервных копий базы данных и файлов проекта
- `Updates` — Система обновления платформы
- `Processing` — Обработка и выполнение служебных задач в админке
  - `ProcessingProducts` — Специализированная обработка товаров (сброс, импорт)
  - `ProcessingTasks` — Выполнение системных задач: очистка файлов и базы данных
- `Uploads` — Загрузка данных из Excel-файлов в систему
  - `UploadsExcelFields` — Импорт настроек полей из Excel
  - `UploadsExcelListData` — Импорт данных справочников из Excel
  - `UploadsExcelTranslate` — Импорт переводов из Excel в таблицу локализации
- `Orders` — Управление заказами: просмотр, фильтрация и обработка
- `_Example10` — Пример расширения для демонстрации структуры и функционала

##### Подсистема обновлений

Расположение: `packages/WeppsAdmin/Updates/`

**Структура:**
```
Updates/
├── Request.php           # CLI-скрипт управления обновлениями
├── files/
│   └── updates/         # Директория с файлами обновлений
│       └── [tag]/       # Директория конкретной версии
│           ├── log.conf                      # Журнал файлов
│           ├── log-db.conf                   # Журнал БД
│           ├── wepps.platform-diff.zip       # Новые файлы
│           ├── wepps.platform-rollback.zip   # Файлы отката
│           └── wepps.platform-updates.zip    # Все файлы обновления
```

Подробнее см. [Обновление](Updates.md).

#### WeppsExtensions/
**Назначение:** Расширения платформы.

**Содержит:**
- Дополнительные модули
- Плагины
- Интеграции с внешними сервисами
- Пользовательские компоненты

#### composer.json
**Назначение:** Описание Composer-зависимостей.

**Основные зависимости:**
- Smarty — шаблонизатор
- Другие PHP-библиотеки

#### vendor_local/
**Назначение:** Локальные библиотеки (пакеты), которых нет в Composer.

### Директория _wepps/

**Назначение:** Точка входа в админ-панель.

**Безопасность:** Доступ к этой директории через веб запрещён файлом (желательно) `.htaccess`.

**Содержит:**
- Интерфейс администрирования

## Workflow запроса

### Обработка HTTP-запроса

1. **Точка входа** (`index.php`)
   - Получение HTTP-запроса
   - Загрузка конфигурации через `configloader.php`

2. **Инициализация ядра** (`WeppsCore`)
   - Загрузка автозагрузчика
   - Инициализация компонентов
   - Подключение к БД

3. **Маршрутизация** (`WeppsCore/Navigator`)
   - Разбор URL
   - Определение контроллера и действия

4. **Выполнение контроллера**
   - Обработка бизнес-логики
   - Работа с моделями и БД

5. **Рендеринг шаблона** (`WeppsCore/Template`)
   - Подготовка данных для шаблона
   - Рендеринг через Smarty

6. **Отправка ответа**
   - Формирование HTTP-ответа
   - Отправка клиенту

### REST API запрос

1. **Точка входа** (`index.php`)
2. **Инициализация ядра**
3. **API маршрутизация**
4. **Выполнение API-контроллера**
5. **Формирование JSON-ответа**
6. **Отправка ответа**

## Расширение функциональности

### Создание нового модуля

Для создания нового модуля в директории `packages/`:

1. Создайте директорию модуля: `packages/MyModule/`
2. Создайте структуру:
   ```
   MyModule/
   ├── Controllers/     # Контроллеры
   ├── Models/         # Модели
   ├── Views/          # Шаблоны
   ├── Config/         # Конфигурация
   └── init.php        # Инициализация модуля
   ```
3. Зарегистрируйте модуль в системе

### Создание расширения

Расширения размещаются в `packages/WeppsExtensions/`:

1. В списке "Расширения" создайте новый элемент
2. При этом будет создана папка с файлами из шаблонов packages/WeppsExtensions/_Example10 (или _Example11)
3. Реализуйте необходимую функциональность
4. Подключите расширение к разделу сайта через "Навигатор"

## Файловая организация

### Принципы организации

- **Модульность** — функциональность разделена на независимые расширения (модули)
- **Разделение ответственности** — каждый компонент отвечает за свою область
- **MVC-паттерн** — разделение на модели, представления и контроллеры
- **Автозагрузка** — использование Composer autoload

### Соглашения об именовании

- **Структура** Папки расширения `packages/WeppsExtensions/ExampleFolder/`
- **Расширениы:** `packages/WeppsExtensions/ExampleFolder/ExampleFolder.php`
- **Шаблоны:** `packages/WeppsExtensions/ExampleFolder/ExampleFolder.tpl` (Smarty templates)
- **CSS-файлы:** `packages/WeppsExtensions/ExampleFolder/ExampleFolder.css`
- **JS-файлы:** `packages/WeppsExtensions/ExampleFolder/ExampleFolder.js`
- **Запросы:** `packages/WeppsExtensions/ExampleFolder/Request.php`
- **Дополнительные файлы** `packages/WeppsExtensions/ExampleFolder/files/*` (файлы конфигурации и проч.)

## Безопасность директорий

### Ограничение доступа

Директории, к которым запрещён веб-доступ:
- `_wepps/` — через `.htaccess`
- `packages/` (частично) — внутренние компоненты

### Права доступа

Рекомендуемые права доступа:

```bash
# Основные файлы (только чтение для веб-сервера)
find /var/www/site -type f -exec chmod 644 {} \;
find /var/www/site -type d -exec chmod 755 {} \;

# Служебные директории (запись для веб-сервера)
chmod -R 755 /var/www/site/_wepps
chmod -R 755 /var/www/site/packages/WeppsAdmin/Updates

# Конфигурационные файлы (ограниченный доступ)
chmod 600 /var/www/site/config.php
chmod 600 /var/www/site/config.cnf
```

## Зависимости

### PHP-зависимости (Composer)

Управление зависимостями через Composer:

```bash
cd /var/www/site/packages
php composer.phar install    # Установка
php composer.phar update     # Обновление
php composer.phar require    # Добавление новой зависимости
```

### Системные зависимости

- Apache 2.x
- PHP 7.4+ (рекомендуется 8.4)
- MySQL 5.7+ (рекомендуется 8.0)
- PHP-модули: curl, xml, mbstring, zip, pdo, gd, memcached

## См. также

- [Установка](Installation.md)
- [Конфигурация](Configuration.md)
- [Обновление](Updates.md)
- [Возможности](Features.md)
