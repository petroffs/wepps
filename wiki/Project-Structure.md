# Структура проекта Wepps

## Обзор

Wepps использует модульную архитектуру, где функциональность разделена на отдельные пакеты и компоненты.

## Основные директории и файлы

```
wepps/
├── index.php              # Точка входа приложения
├── install.php            # Скрипт установки
├── config.php             # Конфигурация проекта
├── config.cnf             # Конфигурация MySQL для CLI
├── configloader.php       # Загрузчик конфигурации
├── favicon.ico            # Иконка сайта
├── LICENSE                # Лицензия MIT
├── README.md              # Основная документация
├── .gitignore             # Правила игнорирования Git
├── packages/              # Основные модули платформы
│   ├── WeppsCore/        # Ядро системы
│   ├── WeppsAdmin/       # Административная панель
│   ├── WeppsExtensions/  # Расширения
│   ├── composer.json     # Composer-зависимости
│   └── vendor_local/     # Локальные Composer-пакеты
└── _wepps/               # Служебная директория
    ├── .htaccess         # Запрет доступа к служебным файлам
    └── index.php         # Заглушка
```

## Описание компонентов

### Корневые файлы

#### index.php
**Назначение:** Главная точка входа в приложение.

Этот файл обрабатывает все входящие HTTP-запросы и инициализирует процесс загрузки приложения.

#### install.php
**Назначение:** Скрипт установки платформы.

**Функциональность:**
- Проверка наличия Composer-зависимостей
- Установка/обновление зависимостей
- Заполнение базы данных из дампа
- Создание учётной записи администратора

#### config.php
**Назначение:** Основной конфигурационный файл.

**Содержит:**
- Параметры подключения к БД
- Пути к директориям
- Настройки окружения
- Параметры кэширования

Подробнее см. [Конфигурация](Configuration.md).

#### config.cnf
**Назначение:** Конфигурация MySQL для CLI-операций.

Используется скриптами резервного копирования и обновления для доступа к базе данных.

#### configloader.php
**Назначение:** Загрузчик конфигурации.

Отвечает за загрузку и инициализацию настроек приложения из `config.php`.

### Директория packages/

#### WeppsCore/
**Назначение:** Ядро системы.

**Содержит:**
- Базовые классы и интерфейсы
- Система маршрутизации
- Работа с базой данных
- Обработка запросов и ответов
- Система шаблонизации (Smarty)
- Утилиты и хелперы

**Основные компоненты:**
- `Router` — система маршрутизации
- `Database` — работа с БД
- `Template` — интеграция Smarty
- `Request/Response` — обработка HTTP
- `Config` — управление конфигурацией

#### WeppsAdmin/
**Назначение:** Административная панель.

**Содержит:**
- Интерфейс администрирования
- Система обновлений
- Управление пользователями
- Управление контентом
- Резервное копирование

**Основные компоненты:**
- `Updates/` — система обновлений
  - `Request.php` — CLI-скрипт для управления обновлениями
  - `files/` — файлы обновлений
- `Admin/` — контроллеры административной панели
- `Views/` — шаблоны административного интерфейса

##### Подсистема обновлений

Расположение: `packages/WeppsAdmin/Updates/`

**Структура:**
```
Updates/
├── Request.php           # CLI-скрипт управления обновлениями
├── files/
│   └── updates/         # Директория с файлами обновлений
│       └── [tag]/       # Директория конкретной версии
│           ├── log.conf                      # Журнал файлов
│           ├── log-db.conf                   # Журнал БД
│           ├── wepps.platform-diff.zip       # Новые файлы
│           ├── wepps.platform-rollback.zip   # Файлы отката
│           └── wepps.platform-updates.zip    # Все файлы обновления
```

Подробнее см. [Обновление](Updates.md).

#### WeppsExtensions/
**Назначение:** Расширения платформы.

**Содержит:**
- Дополнительные модули
- Плагины
- Интеграции с внешними сервисами
- Пользовательские компоненты

#### composer.json
**Назначение:** Описание Composer-зависимостей.

**Основные зависимости:**
- Smarty — шаблонизатор
- Другие PHP-библиотеки

#### vendor_local/
**Назначение:** Локальные Composer-пакеты.

Содержит установленные зависимости из `composer.json`.

### Директория _wepps/

**Назначение:** Служебная директория для внутренних нужд платформы.

**Безопасность:** Доступ к этой директории через веб запрещён файлом `.htaccess`.

**Содержит:**
- Временные файлы
- Кэш
- Сессии
- Логи

## Workflow запроса

### Обработка HTTP-запроса

1. **Точка входа** (`index.php`)
   - Получение HTTP-запроса
   - Загрузка конфигурации через `configloader.php`

2. **Инициализация ядра** (`WeppsCore`)
   - Загрузка автозагрузчика
   - Инициализация компонентов
   - Подключение к БД

3. **Маршрутизация** (`WeppsCore/Router`)
   - Разбор URL
   - Определение контроллера и действия

4. **Выполнение контроллера**
   - Обработка бизнес-логики
   - Работа с моделями и БД

5. **Рендеринг шаблона** (`WeppsCore/Template`)
   - Подготовка данных для шаблона
   - Рендеринг через Smarty

6. **Отправка ответа**
   - Формирование HTTP-ответа
   - Отправка клиенту

### REST API запрос

1. **Точка входа** (`index.php`)
2. **Инициализация ядра**
3. **API маршрутизация**
4. **Выполнение API-контроллера**
5. **Формирование JSON-ответа**
6. **Отправка ответа**

## Расширение функциональности

### Создание нового модуля

Для создания нового модуля в директории `packages/`:

1. Создайте директорию модуля: `packages/MyModule/`
2. Создайте структуру:
   ```
   MyModule/
   ├── Controllers/     # Контроллеры
   ├── Models/         # Модели
   ├── Views/          # Шаблоны
   ├── Config/         # Конфигурация
   └── init.php        # Инициализация модуля
   ```
3. Зарегистрируйте модуль в системе

### Создание расширения

Расширения размещаются в `packages/WeppsExtensions/`:

1. Создайте директорию расширения
2. Реализуйте необходимую функциональность
3. Подключите расширение через систему плагинов

## Файловая организация

### Принципы организации

- **Модульность** — функциональность разделена на независимые модули
- **Разделение ответственности** — каждый компонент отвечает за свою область
- **MVC-паттерн** — разделение на модели, представления и контроллеры
- **Автозагрузка** — использование Composer autoload

### Соглашения об именовании

- **Контроллеры:** `NameController.php`
- **Модели:** `NameModel.php`
- **Представления:** `name.tpl` (Smarty templates)
- **Конфигурация:** `config.php`, `*.conf`

## Безопасность директорий

### Ограничение доступа

Директории, к которым запрещён веб-доступ:
- `_wepps/` — через `.htaccess`
- `packages/` (частично) — внутренние компоненты

### Права доступа

Рекомендуемые права доступа:

```bash
# Основные файлы (только чтение для веб-сервера)
find /var/www/site -type f -exec chmod 644 {} \;
find /var/www/site -type d -exec chmod 755 {} \;

# Служебные директории (запись для веб-сервера)
chmod -R 755 /var/www/site/_wepps
chmod -R 755 /var/www/site/packages/WeppsAdmin/Updates

# Конфигурационные файлы (ограниченный доступ)
chmod 600 /var/www/site/config.php
chmod 600 /var/www/site/config.cnf
```

## Зависимости

### PHP-зависимости (Composer)

Управление зависимостями через Composer:

```bash
cd /var/www/site/packages
php composer.phar install    # Установка
php composer.phar update     # Обновление
php composer.phar require    # Добавление новой зависимости
```

### Системные зависимости

- Apache 2.x
- PHP 7.4+ (рекомендуется 8.4)
- MySQL 5.7+ (рекомендуется 8.0)
- PHP-модули: curl, xml, mbstring, zip, pdo, gd, memcached

## См. также

- [Установка](Installation.md)
- [Конфигурация](Configuration.md)
- [Обновление](Updates.md)
- [Возможности](Features.md)
